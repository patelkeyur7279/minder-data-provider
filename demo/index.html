<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minder Data Provider Demo</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Mock implementation for demo
        const { useState, useEffect, createContext, useContext } = React;
        
        // Mock MinderDataProvider for demo
        const MinderContext = createContext(null);
        
        function MinderDataProvider({ config, children }) {
            const contextValue = {
                config,
                apiClient: {
                    request: async (route, data, params) => {
                        // Mock API responses
                        if (route === 'users') {
                            return [
                                { id: 1, name: 'John Doe', email: 'john@example.com' },
                                { id: 2, name: 'Jane Smith', email: 'jane@example.com' },
                            ];
                        }
                        return { id: Date.now(), ...data };
                    }
                },
                authManager: {
                    token: null,
                    setToken: (token) => { localStorage.setItem('token', token); },
                    getToken: () => localStorage.getItem('token'),
                    clearAuth: () => { localStorage.removeItem('token'); },
                    isAuthenticated: () => !!localStorage.getItem('token'),
                },
                cacheManager: {
                    cache: new Map(),
                    getCachedData: function(key) { return this.cache.get(key); },
                    setCachedData: function(key, data) { this.cache.set(key, data); },
                    clearCache: function(key) { 
                        if (key) this.cache.delete(key); 
                        else this.cache.clear(); 
                    },
                    getAllCachedQueries: function() { return Array.from(this.cache.entries()); },
                }
            };
            
            return React.createElement(MinderContext.Provider, { value: contextValue }, children);
        }
        
        function useMinderContext() {
            return useContext(MinderContext);
        }
        
        function useOneTouchCrud(routeName) {
            const { apiClient } = useMinderContext();
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState({ fetch: false, create: false, update: false, delete: false });
            const [errors, setErrors] = useState({ current: null, hasError: false, message: '' });
            
            useEffect(() => {
                const fetchData = async () => {
                    setLoading(prev => ({ ...prev, fetch: true }));
                    try {
                        const result = await apiClient.request(routeName);
                        setData(result);
                    } catch (error) {
                        setErrors({ current: error, hasError: true, message: error.message });
                    } finally {
                        setLoading(prev => ({ ...prev, fetch: false }));
                    }
                };
                fetchData();
            }, [routeName]);
            
            const operations = {
                create: async (item) => {
                    setLoading(prev => ({ ...prev, create: true }));
                    try {
                        const result = await apiClient.request('createUser', item);
                        setData(prev => [...prev, result]);
                        return result;
                    } catch (error) {
                        setErrors({ current: error, hasError: true, message: error.message });
                        throw error;
                    } finally {
                        setLoading(prev => ({ ...prev, create: false }));
                    }
                },
                update: async (id, item) => {
                    setLoading(prev => ({ ...prev, update: true }));
                    try {
                        const result = await apiClient.request('updateUser', item, { id });
                        setData(prev => prev.map(d => d.id === id ? { ...d, ...result } : d));
                        return result;
                    } catch (error) {
                        setErrors({ current: error, hasError: true, message: error.message });
                        throw error;
                    } finally {
                        setLoading(prev => ({ ...prev, update: false }));
                    }
                },
                delete: async (id) => {
                    setLoading(prev => ({ ...prev, delete: true }));
                    try {
                        await apiClient.request('deleteUser', undefined, { id });
                        setData(prev => prev.filter(d => d.id !== id));
                    } catch (error) {
                        setErrors({ current: error, hasError: true, message: error.message });
                        throw error;
                    } finally {
                        setLoading(prev => ({ ...prev, delete: false }));
                    }
                },
                refresh: () => {
                    window.location.reload();
                },
                clear: () => {
                    setData([]);
                }
            };
            
            return { data, loading, errors, operations };
        }
        
        function useAuth() {
            const { authManager } = useMinderContext();
            return authManager;
        }
        
        function useCache() {
            const { cacheManager } = useMinderContext();
            return cacheManager;
        }
        
        function useCurrentUser() {
            const auth = useAuth();
            const [user, setUser] = useState(null);
            
            useEffect(() => {
                const token = auth.getToken();
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        setUser(payload);
                    } catch {
                        setUser(null);
                    }
                } else {
                    setUser(null);
                }
            }, [auth]);
            
            return {
                user,
                isLoggedIn: !!user,
                hasRole: (role) => user?.roles?.includes(role) || false,
                hasPermission: (permission) => user?.permissions?.includes(permission) || false,
            };
        }
        
        // Demo Components
        function UserManagement() {
            const { data: users, loading, errors, operations } = useOneTouchCrud('users');
            const [newUser, setNewUser] = useState({ name: '', email: '' });
            
            const handleCreateUser = async () => {
                try {
                    await operations.create(newUser);
                    setNewUser({ name: '', email: '' });
                } catch (error) {
                    console.error('Failed to create user:', error);
                }
            };
            
            return React.createElement('div', { className: 'user-management' },
                React.createElement('h2', null, 'ðŸ‘¥ User Management'),
                React.createElement('div', { className: 'loading-states' },
                    React.createElement('p', null, `Fetch Loading: ${loading.fetch ? 'â³' : 'âœ…'}`),
                    React.createElement('p', null, `Create Loading: ${loading.create ? 'â³' : 'âœ…'}`)
                ),
                errors.hasError && React.createElement('div', { className: 'error' }, `âŒ Error: ${errors.message}`),
                React.createElement('div', { className: 'create-form' },
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'Name',
                        value: newUser.name,
                        onChange: (e) => setNewUser({ ...newUser, name: e.target.value })
                    }),
                    React.createElement('input', {
                        type: 'email',
                        placeholder: 'Email',
                        value: newUser.email,
                        onChange: (e) => setNewUser({ ...newUser, email: e.target.value })
                    }),
                    React.createElement('button', {
                        onClick: handleCreateUser,
                        disabled: loading.create
                    }, loading.create ? 'Creating...' : 'Create User')
                ),
                React.createElement('div', { className: 'users-list' },
                    React.createElement('h3', null, `Users (${users.length})`),
                    ...users.map(user =>
                        React.createElement('div', { key: user.id, className: 'user-item' },
                            React.createElement('span', null, `${user.name} - ${user.email}`),
                            React.createElement('button', {
                                onClick: () => operations.update(user.id, { name: user.name + ' (Updated)' })
                            }, 'Update'),
                            React.createElement('button', {
                                onClick: () => operations.delete(user.id)
                            }, 'Delete')
                        )
                    )
                ),
                React.createElement('div', { className: 'operations' },
                    React.createElement('button', { onClick: operations.refresh }, 'ðŸ”„ Refresh'),
                    React.createElement('button', { onClick: operations.clear }, 'ðŸ—‘ï¸ Clear Cache')
                )
            );
        }
        
        function AuthenticationDemo() {
            const auth = useAuth();
            const currentUser = useCurrentUser();
            
            const handleLogin = () => {
                const mockToken = btoa(JSON.stringify({
                    sub: '123',
                    name: 'John Doe',
                    email: 'john@example.com',
                    roles: ['user'],
                    permissions: ['read', 'write'],
                    exp: Math.floor(Date.now() / 1000) + 3600,
                }));
                auth.setToken(mockToken);
                window.location.reload(); // Refresh to update UI
            };
            
            return React.createElement('div', { className: 'auth-demo' },
                React.createElement('h2', null, 'ðŸ” Authentication'),
                React.createElement('div', { className: 'auth-status' },
                    React.createElement('p', null, `Authenticated: ${auth.isAuthenticated() ? 'âœ…' : 'âŒ'}`),
                    React.createElement('p', null, `Token: ${auth.getToken() ? '***hidden***' : 'None'}`)
                ),
                currentUser.isLoggedIn && React.createElement('div', { className: 'user-info' },
                    React.createElement('h3', null, 'Current User'),
                    React.createElement('p', null, `Name: ${currentUser.user?.name}`),
                    React.createElement('p', null, `Email: ${currentUser.user?.email}`)
                ),
                React.createElement('div', { className: 'auth-actions' },
                    React.createElement('button', { onClick: handleLogin }, 'ðŸ”‘ Login'),
                    React.createElement('button', { onClick: () => { auth.clearAuth(); window.location.reload(); } }, 'ðŸšª Logout')
                )
            );
        }
        
        function CacheDemo() {
            const cache = useCache();
            const [cacheInfo, setCacheInfo] = useState(null);
            
            const inspectCache = () => {
                const usersCache = cache.getCachedData('users');
                const allQueries = cache.getAllCachedQueries();
                
                setCacheInfo({
                    usersInCache: Array.isArray(usersCache) ? usersCache.length : 0,
                    totalQueries: allQueries.length,
                });
            };
            
            return React.createElement('div', { className: 'cache-demo' },
                React.createElement('h2', null, 'ðŸ’¾ Cache Management'),
                React.createElement('div', { className: 'cache-actions' },
                    React.createElement('button', { onClick: inspectCache }, 'ðŸ” Inspect Cache'),
                    React.createElement('button', { onClick: () => cache.clearCache('users') }, 'ðŸ—‘ï¸ Clear Users'),
                    React.createElement('button', { onClick: () => cache.clearCache() }, 'ðŸ§¹ Clear All')
                ),
                cacheInfo && React.createElement('div', { className: 'cache-info' },
                    React.createElement('h3', null, 'Cache Information'),
                    React.createElement('p', null, `Users in Cache: ${cacheInfo.usersInCache}`),
                    React.createElement('p', null, `Total Queries: ${cacheInfo.totalQueries}`)
                )
            );
        }
        
        // Main App
        function DemoApp() {
            return React.createElement('div', { className: 'demo-app' },
                React.createElement('h1', null, 'ðŸš€ Minder Data Provider Demo'),
                React.createElement('div', { className: 'demo-grid' },
                    React.createElement(UserManagement),
                    React.createElement(AuthenticationDemo),
                    React.createElement(CacheDemo)
                )
            );
        }
        
        function App() {
            const config = {
                apiBaseUrl: 'https://jsonplaceholder.typicode.com',
                routes: {
                    users: { method: 'GET', url: '/users', optimistic: true },
                    createUser: { method: 'POST', url: '/users', optimistic: true },
                    updateUser: { method: 'PUT', url: '/users/:id', optimistic: true },
                    deleteUser: { method: 'DELETE', url: '/users/:id', optimistic: true },
                },
                auth: { tokenKey: 'accessToken', storage: 'localStorage' },
            };
            
            return React.createElement(MinderDataProvider, { config },
                React.createElement(DemoApp)
            );
        }
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>